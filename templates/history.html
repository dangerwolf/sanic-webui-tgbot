{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
        <h5 class="m-0">ğŸ“œ å‘é€å†å² (æœ€è¿‘50æ¡)</h5>
        <button class="btn btn-outline-secondary btn-sm" onclick="loadHistory()">
            åˆ·æ–°åˆ—è¡¨
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col" style="width: 5%">ID</th>
                        <th scope="col" style="width: 20%">æ—¶é—´</th>
                        <th scope="col" style="width: 15%">æ¥æºIP</th>
                        <th scope="col" style="width: 45%">å†…å®¹é¢„è§ˆ</th>
                        <th scope="col" style="width: 15%">çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadHistory() {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">åŠ è½½ä¸­...</td></tr>';

        try {
            const response = await fetch('/history?limit=50');
            const data = await response.json();

            tbody.innerHTML = ''; // æ¸…ç©º

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">æš‚æ— è®°å½•</td></tr>';
                return;
            }

            data.forEach(item => {
                const statusBadge = item.success 
                    ? '<span class="badge bg-success">æˆåŠŸ</span>' 
                    : '<span class="badge bg-danger">å¤±è´¥</span>';
                
                // æˆªæ–­è¿‡é•¿çš„å†…å®¹
                let contentPreview = item.content.length > 50 
                    ? item.content.substring(0, 50) + '...' 
                    : item.content;
                // è½¬ä¹‰HTMLé˜²æ­¢æ³¨å…¥
                contentPreview = contentPreview.replace(/</g, "&lt;").replace(/>/g, "&gt;");

                const row = `
                    <tr>
                        <td>${item.id}</td>
                        <td class="text-secondary small">${item.time}</td>
                        <td class="small">${item.ip}</td>
                        <td class="text-break" style="font-family: monospace;">${contentPreview}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
        }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–
    document.addEventListener('DOMContentLoaded', loadHistory);
</script>
{% endblock %}
